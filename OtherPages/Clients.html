<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Global Natural Stones</title>
			
		<link rel="stylesheet" href="../Stylesheets/Reset.css" type="text/css" />
		<link rel="stylesheet" href="../Stylesheets/MainStyles.css" type="text/css"/>
		<link rel="stylesheet" href="../JQUI/jquery-ui.css"/>
    	
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>

		<!-- Icons -->
		<script src='https://kit.fontawesome.com/a076d05399.js'></script>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
			
		<script name="ConstVars">
			const CDATA_FADESPEED = 200;
			let AllClients = [];
		</script>
		
		<script type="text/javascript" src="../JQUI/external/jquery/jquery.js"></script>
		<script type="text/javascript" src="../JQUI/jquery-ui.js"></script>
		
		

	</head>

	<body>
		<script src="MainHeader.js"></script>
		<script>display("Clients");</script>
		
		<div class="big-container">
			<!--side navigation-->
			<aside>				
				<nav id="ClientCategories">			
					
					<div class="SmallCategories">
						<h2>View clients by...</h2>											
						<button class="SmallCatButtons neat-button view-selected">Stage 1</button>
						<button class="SmallCatButtons  neat-button">Stage 2</button>
						<button class="SmallCatButtons  neat-button">Archived</button>
						
					</div>
					
					

					<form>
						<button id="AddClient" class="GreenAdd">+ Add Client</button>
					</form>
				</nav>				
			</aside>
			
			<!--list of clients -->
			<main>
				<div class="sectionHeading">
					<h1 id="sectionTitle">Stage 1</h1>
					<p> Sort by: 
						<select id="SortBy">
							<option value="New" selected>Newest to Oldest</option>
							<option value="Old">Oldest to Newest</option>
							<option value="FirstName">First Name</option>
							<option value="LastName">Last Name</option>
						</select>
					</p>
				</div>
				<hr>
				
				<ul id="ClientList">
					<!--each li is a client-->
					
					
					<li class="Client">
						<section class="ListHead">
							<h4 class="Name">Joe Johnson</h4>
							<p class="cliID">1</p>
							<p class="Joined">Joined 22 January, 2020</p>
							<div class="CHeadTopLinks ">
								<div>
									<button class="btnShowInfo">Show All</button>
									<button class="btnEditInfo">Edit</a>
								</div>
							</div>
						</section>
						
						<section class="ListBody">
							<nav class="SmallCategories">
								<button class="SmallCatButtons Basic">Basic</button>
								<button class="SmallCatButtons Installation">Installation</button>
								<button class="SmallCatButtons Estimate">Estimate/Balance</button>
								<button class="SmallCatButtons Availability">Availability</button>
								<button class="SmallCatButtons Comments">Comments</button>
							</nav>
							
							<div class="ClientData">
								<span class="Info"><h5>Phone:</h5><p class="CPhone">(478) 999-9999</p></span>
								<span class="Info"><h5>Email:</h5><p class="CEmail">JimmyJohJohnson@email.com</p></span>
								
								<span class="Info"><h5>Address:</h5><p class="CAddress">123 Rainbow Road</p></span>
								<span class="Info"><h5>City:</h5><p class="CCity">Dayton</p></span>
								<span class="Info"><h5>State:</h5><p class="CState">OH</p></span>
								<span class="Info"><h5>Zip:</h5><p>12345</p></span>
								
								<span class="Info"><h5>Projects:</h5><p>Cabinet, Appliances, Floor</p></span>
							</div>
							
							<button class="ClientNextPhase">Move client to next phase</button>
							
						</section>
					</li>

					
				</ul>
			</main>
    </div>
	
		<script name="SortFunctions" src="Scripts/SortDisplayFunctions.js"></script>
		<script name="IPC-Initiate">const { ipcRenderer } = require('electron');</script>
		
		<script name="ExpandListBodyClick">
		
		$(document).ready( function() {
	
			//displays the client information when clicking on an li
			$("#ClientList").on('click', ".ListHead", function() {			
				var thisClient = $(this).parent();
				const timeDelay = 200;
				//closes all other clint info's				
				$('.Client').not(thisClient).find(".ListBody").hide(timeDelay);
				$('.Client').not(thisClient).find(".CHeadTopLinks").hide(timeDelay);
				
				//opens the clicked client info
				$(thisClient).find(".ListBody").slideToggle(timeDelay);
				$(thisClient).find(".CHeadTopLinks").toggle(timeDelay);

				$("#comment").remove();
				$("#AddComment").remove();
				$("#cancel").remove();
			});
			
		});
		</script>
		
		<script name="DisplayClients">
			let currentStageForm = 1;
			
			//define htmls
			let html_ButtonsNav = '<nav class="SmallCategories"><button class="SmallCatButtons Basic smallcat-selected">Basic</button><button class="SmallCatButtons Estimate">Estimate/Balance</button><button class="SmallCatButtons Availability">Availability</button><button class="SmallCatButtons Comments">Comments</button><div style="width: 100%; border: 0.5px solid rgb(180,180,180);"></div></nav>';			
			let html_TopNav = '<div class="CHeadTopLinks"><div><button class="btnShowInfo"><i class="fa fa-list"></i>Show All</button><button class="btnEditInfo"><i class="fa fa-edit"></i>Edit</div></div>';
			let html_DivSec = "<div class='body-section'></div>";
			
			/**************FUNCTIONS****************/
			//populate client body functions
			function populateBasic(clientBas, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				$("<label class='info'>Phone: <p>" + p(clientBas.phone) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Email: <p>" + p(clientBas.email) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Address: <p>" + p(clientBas.street_address) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>City: <p>" + p(clientBas.city) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>State: <p>" + p(clientBas.state) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Zip code: <p>" + p(clientBas.zip) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
			}
			
			function populateAvailability(clientAv, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
				let div1 = $(html_DivSec);
				let div2 = $(html_DivSec);
				
				$("<h4>Schedule</h4><br>").appendTo(div1);
				$("<label class='info'>Template: <p>" + formatDate(clientAv.schedule_template) + "</p></label>").appendTo(div1);
				$("<label class='info'>Tear: <p>" + formatDate(clientAv.schedule_tear) + "</p></label>").appendTo(div1);
				$("<label class='info'>Brackets: <p>" + formatDate(clientAv.schedule_brackets) + "</p></label>").appendTo(div1);
				$("<label class='info'>Install/Dropoff: <p>" + formatDate(clientAv.schedule_install_drop) + "</p></label>").appendTo(div1);
				$("<label class='info'>Plumbing: <p>" + formatDate(clientAv.schedule_plumb) + "</p></label>").appendTo(div1);
				
				$("<h4>Customer Picked Up</h4><br>").appendTo(div2);
				$("<label class='info'>Faucet: <p>" + formatDate(clientAv.picked_faucet) + "</p></label>").appendTo(div2);
				$("<label class='info'>Grid set: <p>" + formatDate(clientAv.picked_grid) + "</p></label>").appendTo(div2);
				$("<label class='info'>Strainer: <p>" + formatDate(clientAv.picked_strainer) + "</p></label>").appendTo(div2);
				$("<label class='info'>Brackets: <p>" + formatDate(clientAv.picked_brackets) + "</p></label>").appendTo(div2);
				$("<label class='info'>Counters: <p>" + formatDate(clientAv.picked_counters) + "</p></label>").appendTo(div2);
				
				$(clientData).append(div1).append(div2);
			}
			
			function populateEstimate(clientEst, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				$("<label class='info'>Estimated Q: <p>" + c(clientEst.actual_qty) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Actual Q: <p>" + c(clientEst.actual_qty) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Estimate: <p>" + c(clientEst.estimate) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Notes for Installation: <textarea readonly>" + pp(clientEst.estimate) + "</textarea></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
			}
			
			function populateComments(clientCom, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				if (!clientCom.comments || clientCom.comments == [] || !aString(clientCom.comments[0]) || !aString(clientCom.comments))
					$("<p class='info'>No comments for this user yet</p><br>").appendTo(clientData);
				else {
					for(var c = 0; c < clientCom.comments.length; c++){
						const comment = `
							<div class="comContainer">
								<div>
									<img src='${clientCom.comments[c].author_picture}'/><h4>${clientCom.comments[c].author_name}</h4><strong>${new Date(clientCom.comments[c].date).toDateString()}</strong>
								</div>
								<p>${clientCom.comments[c].message}</p>
							</div><br>
						`;
						$(comment).appendTo(clientData);
						//$("<p class='info'>" + clientCom.comments[c] + "</p><br>").appendTo(clientData);
					}
				}
				//Textbox for the comment
				let commentBox = $("<input type='text' id='comment' placeholder='Comment...'/>");
				commentBox.hide();
				clientData.append(commentBox);
				//Add the add comment button at the end
				$(`<br><button id="AddComment" class="BlueAdd">+ Add Comment</button>`).appendTo(clientData);
				$("<button id='cancel' class='BlueAdd'>Cancel</button>").appendTo(clientData).hide();

				//Keeps track of if the user is adding a comment or not
				let isCommenting = false;
				$("#AddComment").on('click', () => {
					//If the user hasn't opened the text box yet
					if (!isCommenting) {
						//Open it
						$("#comment").show();
						$("#cancel").show();
						$("#AddComment").text("Submit");
					} else {
						//If they have, close it and submit the comment
						//Get the text
						const message = $("#comment").val();
						if (!messsage) return;
						//Send it to the main process
						ipcRenderer.send('addComment', {message, client_id: clientCom.id});
						closeComment();
					}
					isCommenting = !isCommenting;
				});
				$("#cancel").on('click', () => {
					isCommenting = false;
					closeComment();
					$("#comment").val('');
				});
			}
			function closeComment() {
				$("#comment").hide();
				$("#cancel").hide();
				$("#AddComment").text("+ Add Comment");
			}
			//makes single client html
			function makeAClient(client, stage){
				let btnMessage ="";				
				switch (stage){
					case 1:
						btnMessage = "Move to stage 2<i class='fa fa-arrow-right'></i>";
						break;
					case 2:
						btnMessage = "Archive client";
						break;
					case 3:
						btnMessage = "Move to previous stage";
						break;
					default:
						btnMessage = "none";
						break;
				}
			
				let htmlLI = $('<li class="Client"></li>'); //make li
				
				//make ListBody
				let htmlLiBody = $("<section class='ListBody'></section>")
					.append('<div class="ClientData"></div>')
					.append("<button class='ClientNextPhase'>" + btnMessage + "</button>").append(html_ButtonsNav); 
				
				//make the head
				let htmlLiHead = $("<section class='ListHead'></section>")
					.append("<h4>" + client.first_name + " " + client.last_name + "</h4>")
					.append("<p class='cliID'>" + client.id + "</p>")
					.append("<p>Joined " + formatDate(client.date_added) + "</p>")
					.append(html_TopNav);
				
				populateBasic(client, htmlLiBody);
					
				return $(htmlLI).append(htmlLiHead).append(htmlLiBody);
			}
			
			//populates main (all clients)
			function populateMain(currentStage){
				console.log("Loading clients from stage " + currentStage);
				var Client;
				
				//remove clients in the form already
				$(".Client").remove();
				
				//makes and appends all clients
				for (Client of AllClients){			
					$(makeAClient(Client, currentStage)).hide().appendTo("#ClientList").fadeIn(600);
				}
				
			}	
			
			function recievedClients(stage){
				$("body").removeClass("ui-widget-overlay");
				
				sortByNewest(AllClients)
				populateMain(stage);
				
				console.log("new clients recieved from the server");
			}

			/*****************JQUERY******************/
			$(document).ready(function(){

				//fill buttons with stage info
				let btnNum = 1;
				$(".SmallCatButtons").each(function(){
					$(this).attr("Stage", btnNum++);
				});

				
				//when the button is clicked, fill the main
				$("aside .SmallCatButtons").click(function(){
					$("#sectionTitle").text($(this).text());
					currentStageForm = parseInt($(this).attr("stage"));		
					
					//populateMain(currentStageForm); //[DEV, GET RID LATER]
					ipcRenderer.send("RequestStage" + currentStageForm);
					console.log('Sent stage ' + currentStageForm + ' client request');

					//styling
					$("aside .SmallCatButtons").removeClass("view-selected");
					$(this).addClass("view-selected");
				});
		
				
				/*******************JQUI******************/
				
				//sort by selectmenu
				$("#SortBy").selectmenu({
					width: 200,
					  classes: {
						"ui-selectmenu-button": "custom-clear",
						"ui-selectmenu-text": "custom-underline",
						"ui-selectmenu-button-closed": "custom-clear"
					  },
				
					change: function(event, data){
						switch (data.item.value){
							case "New":
								sortByNewest(AllClients);
								break;
							case "Old":
								sortByOldest(AllClients);
								break;
							case "FirstName":
								sortByFirstName(AllClients);
								break;
							case "LastName":
								sortByLastName(AllClients);
								break;
						}
						
						populateMain(currentStageForm);
					}
				});	
				
				
			});
			
			//Sign out
			function signOut() {
				ipcRenderer.send('signout');
			}
		</script>
			
		<script name="NavigateClients">
			$(document).ready(function(){
			
				$("#ClientList").on("click", ".ListBody .SmallCategories button", function(){
					let ThisListBody = $(this).parent().parent();
					let ThisID = ThisListBody.parent().find(".cliID").text();
					let ThisClientData = $(ThisListBody).find(".ClientData");
					
					//remove the things already there
					$(ThisClientData).children().remove();
					$(ThisClientData).hide();
					
					//styling 
					$(".ListBody .SmallCategories button").removeClass("smallcat-selected");
					$(this).addClass("smallcat-selected");
					
					//fill info 				
					if ($(this).hasClass("Estimate")){
						//display Invoice
						console.log("client invoice is displayed");						
						populateEstimate(getClient(AllClients, ThisID), ThisListBody);
					}
					else if ($(this).hasClass("Availability")){
						//display install stuff
						console.log("client install is displayed");				
						populateAvailability(getClient(AllClients, ThisID), ThisListBody);
					}
					else if ($(this).hasClass("Comments")){
						//display install stuff
						console.log("client comments are displayed");						
						populateComments(getClient(AllClients,ThisID), ThisListBody);
					}
					else {
						//display basic (if none other found)
						populateBasic(getClient(AllClients,ThisID), ThisListBody);
					}
					
					$(ThisClientData).fadeIn(CDATA_FADESPEED);
				});
				
				$("#ClientList").on("click", ".ClientNextPhase", function(){
					let thisID = parseInt($(this).parent().parent().find(".cliID").text());
					let newStage = currentStageForm >= 3 ? 2 : currentStageForm++;
					
					ipcRenderer.send("NewStage", {client_id: thisID, new_stage: newStage})
				});
				
			});
		</script>
		
		<script name="IPC-Functions">
		
		/*********SEND*********/
		//when the show info button clicked
		$("#ClientList").on("click", ".btnShowInfo", function() {
			//send the 'display-client' command to the main js (will display new page with client info)
			//needs id
			let cliID = $(this).parent().parent().parent().find(".cliID").text();
			
			ipcRenderer.send("display-client-info", getClient(AllClients, cliID));
		});
		
		$("#ClientList").on("click", ".btnEditInfo", function(e) {
			//send the 'display-client-edit' command to the main js (will display new page with client info)
			//needs id
			let cliID = $(this).parent().parent().parent().find(".cliID").text();
			
			ipcRenderer.send("display-client-edit", getClient(AllClients, cliID));
			$("body").addClass("ui-widget-overlay");
			e.stopPropagation();
		});
		
		//Update the profile picture
		window.onload = () => {
			ipcRenderer.send("user");
		}
		
		
		/*********Recieve**********/
		//extra window is closed, remove the gray out overlay
		ipcRenderer.on("ExtraWinClosed", (event) =>{
			$("body").removeClass("ui-widget-overlay");
		});
		
		//gets an updated client array
		ipcRenderer.on("updatedClients", (event, data) =>{			
			AllClients = data.cliarr;
			let sentStage = data.stage == 0 ? currentStageForm : data.stage;
			sortByNewest(AllClients);
			populateMain(sentStage);
			console.log("new clients recieved from the server");
		});
		
		//received a new comment
		ipcRenderer.on("addComment", (event, comment) =>{
			for (var i = 0; i < AllClients.length(); i++){
				if (comment.client_id == AllClients[i].id){
					AllClients[i].comments.push(comment);
					return;
				}
			}
		});
		//a comment has been deleted
		ipcRenderer.on("delComment", (event, data) =>{
			//find the client
			for (var i = 0; i < AllClients.length(); i++){
				if (data.client_id == AllClients[i].id){
					
					//find the comment
					for (var comi = 0; comi < AllClients[i].comments.length(); i++){
						if (data.comment_id == AllClients[i].comments[comi].id)						
							AllClients[i].comments.splice(comi, 1); //delete comment
							
					}
					
					return
				}
			}
		});
		
		//one client is updated
		ipcRenderer.on("updateOneClient", (event, newcli)=>{
			for (var i = 0; i < AllClients.length() && currentStageForm == newcli.stage; i++){
				if (newcli.id == AllClients[i].id){
					AllClients[i] = newcli;
					return;
				}
			}
		});
		
		//a new client has been added to the database
		ipcRenderer.on("newClient", (event, newcli)=> {
			if (newcli.stage == currentStageForm){
				AllClients.push(newcli);
				sortByFirstName(AllClients);
				populateMain(currentStageForm);
			}
		});
		
		//a client has been moved to a different stage
		ipcRenderer.on("changedStage", (event, data)=>{
			for (var i = 0; i < AllClients.length() && currentStageForm == data.new_stage; i++){
				if (AllClients[i].id = data.client_id)
					AllClients.splice(i, 1); //delete client
			}
		});
		
		//get google profile picture
		ipcRenderer.on("getUser", (event, user) => {
			document.getElementById('profilePic').setAttribute('src',user.picture);
		});


		
		</script>
		
		<script src="Scripts/TestDatabase.js"></script>
		<script name="DEV, Test ipcRenderer!">
		AllClients = testData;
		
		sortByNewest(AllClients);
		populateMain(1);
		</script>
	</body>
</html>