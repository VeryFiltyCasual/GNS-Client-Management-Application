<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Global Natural Stones</title>
			
		<link rel="stylesheet" href="../Stylesheets/Reset.css" type="text/css" />
		<link rel="stylesheet" href="../Stylesheets/MainStyles.css" type="text/css"/>
		<link rel="stylesheet" href="../JQUI/jquery-ui.css"/>
    	
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>

		<!-- Icons -->
		<script src='https://kit.fontawesome.com/a076d05399.js'></script>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
			
		<script name="ConstVars">
			const CDATA_FADESPEED = 200;
			let AllClients = [];
		</script>
		
		<script type="text/javascript" src="../JQUI/external/jquery/jquery.js"></script>
		<script type="text/javascript" src="../JQUI/jquery-ui.js"></script>
		
		

	</head>

	<body>
		<script src="MainHeader.js"></script>
		<script>display("Clients");</script>
		
		<div class="big-container">
			<!--side navigation-->
			<aside>				
				<nav id="ClientCategories">			
					
					<div class="SmallCategories">
						<h2>View clients by...</h2>											
						<button class="SmallCatButtons neat-button">Stage 1</button>
						<button class="SmallCatButtons  neat-button">Stage 2</button>
						<button class="SmallCatButtons  neat-button">Archived</button>
						
					</div>
					
					

					<form>
						<button id="AddClient" class="GreenAdd">+ Add Client</button>
					</form>
				</nav>				
			</aside>
			
			<!--list of clients -->
			<main>
				<div class="sectionHeading">
					<h1 id="sectionTitle">Stage 1</h1>
					<p> Sort by: 
						<select id="SortBy">
							<option value="New" selected>Newest to Oldest</option>
							<option value="Old">Oldest to Newest</option>
							<option value="FirstName">First Name</option>
							<option value="LastName">Last Name</option>
						</select>
					</p>
				</div>
				<hr>
				
				<ul id="ClientList">
					<!--each li is a client-->
					
					
					<li class="Client">
						<section class="ListHead">
							<h4 class="Name">Joe Johnson</h4>
							<p class="cliID">1</p>
							<p class="Joined">Joined 22 January, 2020</p>
							<div class="CHeadTopLinks ">
								<div>
									<button class="btnShowInfo">Show All</button>
									<button class="btnEditInfo">Edit</a>
								</div>
							</div>
						</section>
						
						<section class="ListBody">
							<nav class="SmallCategories">
								<button class="SmallCatButtons Basic">Basic</button>
								<button class="SmallCatButtons Installation">Installation</button>
								<button class="SmallCatButtons Estimate">Estimate/Balance</button>
								<button class="SmallCatButtons Availability">Availability</button>
								<button class="SmallCatButtons Comments">Comments</button>
							</nav>
							
							<div class="ClientData">
								<span class="Info"><h5>Phone:</h5><p class="CPhone">(478) 999-9999</p></span>
								<span class="Info"><h5>Email:</h5><p class="CEmail">JimmyJohJohnson@email.com</p></span>
								
								<span class="Info"><h5>Address:</h5><p class="CAddress">123 Rainbow Road</p></span>
								<span class="Info"><h5>City:</h5><p class="CCity">Dayton</p></span>
								<span class="Info"><h5>State:</h5><p class="CState">OH</p></span>
								<span class="Info"><h5>Zip:</h5><p>12345</p></span>
								
								<span class="Info"><h5>Projects:</h5><p>Cabinet, Appliances, Floor</p></span>
							</div>
							
							<button class="ClientNextPhase">Move client to next phase</button>
							
						</section>
					</li>

					
				</ul>
			</main>
    </div>
	
		<script name="SortFunctions" src="Scripts/SortDisplayFunctions.js"></script>
		<script name="IPC-Initiate">const { ipcRenderer } = require('electron');</script>
		
		<script name="ExpandListBodyClick">
		
		$(document).ready( function() {
	
			//displays the client information when clicking on an li
			$("#ClientList").on('click', ".ListHead", function() {			
				var thisClient = $(this).parent();
				
				//closes all other clint info's				
				$('.Client').not(thisClient).find(".ListBody").hide(400);
				$('.Client').not(thisClient).find(".CHeadTopLinks").hide(400);
				
				//opens the clicked client info
				$(thisClient).find(".ListBody").slideToggle(400);
				$(thisClient).find(".CHeadTopLinks").toggle(400);
			});
			
		});
		</script>
		
		<script name="DisplayClients">
			let currentStageForm = 1;
			
			//define htmls
			let html_ButtonsNav = '<nav class="SmallCategories"><button class="SmallCatButtons Basic">Basic</button><button class="SmallCatButtons Estimate">Estimate/Balance</button><button class="SmallCatButtons Availability">Availability</button><button class="SmallCatButtons Comments">Comments</button></nav>';			
			let html_TopNav = '<div class="CHeadTopLinks"><div><button class="btnShowInfo">Show All</button><button class="btnEditInfo">Edit</a></div></div>';
			let html_DivSec = "<div class='body-section'></div>";
			
			//populate client body functions
			function populateBasic(clientBas, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				$("<label class='info'>Phone: <p>" + p(clientBas.phone) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Email: <p>" + p(clientBas.email) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Address: <p>" + p(clientBas.street_address) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>City: <p>" + p(clientBas.city) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>State: <p>" + p(clientBas.state) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				
				$("<label class='info'>Zip code: <p>" + p(clientBas.zip) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
			}
			
			function populateAvailability(clientAv, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
				let div1 = $(html_DivSec);
				let div2 = $(html_DivSec);
				
				$("<h4>Schedule</h4><br>").appendTo(div1);
				$("<label class='info'>Template: <p>" + formatDate(clientAv.schedule_template) + "</p></label>").appendTo(div1);
				$("<label class='info'>Tear: <p>" + formatDate(clientAv.schedule_tear) + "</p></label>").appendTo(div1);
				$("<label class='info'>Brackets: <p>" + formatDate(clientAv.schedule_brackets) + "</p></label>").appendTo(div1);
				$("<label class='info'>Install/Dropoff: <p>" + formatDate(clientAv.schedule_install_drop) + "</p></label>").appendTo(div1);
				$("<label class='info'>Plumbing: <p>" + formatDate(clientAv.schedule_plumb) + "</p></label>").appendTo(div1);
				
				$("<h4>Customer Picked Up</h4><br>").appendTo(div2);
				$("<label class='info'>Faucet: <p>" + formatDate(clientAv.picked_faucet) + "</p></label>").appendTo(div2);
				$("<label class='info'>Grid set: <p>" + formatDate(clientAv.picked_grid) + "</p></label>").appendTo(div2);
				$("<label class='info'>Strainer: <p>" + formatDate(clientAv.picked_strainer) + "</p></label>").appendTo(div2);
				$("<label class='info'>Brackets: <p>" + formatDate(clientAv.picked_brackets) + "</p></label>").appendTo(div2);
				$("<label class='info'>Counters: <p>" + formatDate(clientAv.picked_counters) + "</p></label>").appendTo(div2);
				
				$(clientData).append(div1).append(div2);
			}
			
			function populateEstimate(clientEst, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				$("<label class='info'>Estimated Q: <p>" + c(clientEst.actual_qty) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Actual Q: <p>" + c(clientEst.actual_qty) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Estimate: <p>" + c(clientEst.estimate) + "</p></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
				$("<label class='info'>Notes for Installation: <textarea readonly>" + pp(clientEst.estimate) + "</textarea></label>").appendTo(clientData).fadeIn(CDATA_FADESPEED);
			}
			
			function populateComments(clientCom, thisCliInfo){
				let clientData = $(thisCliInfo).find(".ClientData");
			
				if (clientCom.comments == [] || !aString(clientCom.comments[0]) || !aString(clientCom.comments))
					$("<p class='info'>No comments for this user yet</p>").appendTo(clientData);
				else {
					for(var c = 0; c < clientCom.comments.length; c++){
						$("<p class='info'>" + clientCom.comments[c] + "</p><br>").appendTo(clientData);
					}
				}
			}
			
			//makes single client html
			function makeAClient(client, stage){
				let btnMessage ="";				
				switch (stage){
					case 1:
						btnMessage = "Move to stage 2";
						break;
					case 2:
						btnMessage = "Archive client";
						break;
					case 3:
						btnMessage = "Move to previous stage";
						break;
					default:
						btnMessage = "none";
						break;
				}
			
				let htmlLI = $('<li class="Client"></li>'); //make li
				
				//make ListBody
				let htmlLiBody = $("<section class='ListBody'></section>")
					.append(html_ButtonsNav)
					.append('<div class="ClientData"></div>')
					.append("<button class='ClientNextPhase'>" + btnMessage + "</button>"); 
				console.log(btnMessage);
				
				//make the head
				let htmlLiHead = $("<section class='ListHead'></section>")
					.append("<h4>" + client.first_name + " " + client.last_name + "</h4>")
					.append("<p class='cliID'>" + client.id + "</p>")
					.append("<p>Joined " + formatDate(client.date_added) + "</p>")
					.append(html_TopNav);
				
				populateBasic(client, htmlLiBody);
					
				return $(htmlLI).append(htmlLiHead).append(htmlLiBody);
			}
			
			//populates main (all clients)
			function populateMain(currentStage){
				console.log("Loading clients from stage " + currentStage);
				var Client;
				
				//remove clients in the form already
				$(".Client").remove();
				
				//makes and appends all clients
				for (Client of AllClients){			
					$(makeAClient(Client, currentStage)).hide().appendTo("#ClientList").fadeIn(600);
				}
				
			}	
			
			
			//when expected a client from server, gray out screen
			function awaitClient(){
				
			}
			
			//jquery, give all butons stage attr and handle clicking, jquery ui
			$(document).ready(function(){

				//fill buttons with stage info
				let btnNum = 1;
				$(".SmallCatButtons").each(function(){
					$(this).attr("Stage", btnNum++);
				});

				
				//when the button is clicked, fill the main
				$("aside .SmallCatButtons").click(function(){
					$("#sectionTitle").text($(this).text());
					currentStageForm = parseInt($(this).attr("stage"));		
					
					populateMain(currentStageForm); //[DEV, GET RID LATER]
					//ipcRenderer.send("RequestStage" + currentStageForm);
					
					//styling
					$("aside .SmallCatButtons").removeClass("view-selected");
					$(this).addClass("view-selected");
				});
		
				
				//jQUI sort by combo box
				$("#SortBy").selectmenu({
					width: 200,
					  classes: {
						"ui-selectmenu-button": "custom-clear",
						"ui-selectmenu-text": "custom-underline",
						"ui-selectmenu-button-closed": "custom-clear"
					  },
				
					change: function(event, data){
						switch (data.item.value){
							case "New":
								sortByNewest(AllClients);
								break;
							case "Old":
								sortByOldest(AllClients);
								break;
							case "FirstName":
								sortByFirstName(AllClients);
								break;
							case "LastName":
								sortByLastName(AllClients);
								break;
						}
						
						populateMain(currentStageForm);
					}
				});	
				
			});
			
			
		</script>
			
		<script name="NavigateClients">
			$(document).ready(function(){
			
				$("#ClientList").on("click", ".ListBody .SmallCategories button", function(){
					let ThisListBody = $(this).parent().parent();
					let ThisID = ThisListBody.parent().find(".cliID").text();
					let ThisClientData = $(ThisListBody).find(".ClientData");
					
					//remove the things already there
					$(ThisClientData).children().remove();
					$(ThisClientData).hide();
					
					//styling 
					$(".ListBody .SmallCategories button").removeClass("smallcat-selected");
					$(this).addClass("smallcat-selected");
					
					//fill info 				
					if ($(this).hasClass("Estimate")){
						//display Invoice
						console.log("client invoice is displayed");						
						populateEstimate(getClient(AllClients, ThisID), ThisListBody);
					}
					else if ($(this).hasClass("Availability")){
						//display install stuff
						console.log("client install is displayed");				
						populateAvailability(getClient(AllClients, ThisID), ThisListBody);
					}
					else if ($(this).hasClass("Comments")){
						//display install stuff
						console.log("client comments are displayed");						
						populateComments(getClient(AllClients,ThisID), ThisListBody);
					}
					else {
						//display basic (if none other found)
						populateBasic(getClient(AllClients,ThisID), ThisListBody);
					}
					
					$(ThisClientData).fadeIn(CDATA_FADESPEED);
				});
				
				$("#ClientList").on("click", ".ClientNextPhase", function(){
					let thisID = parseInt($(this).parent().parent().find(".cliID").text());
					let newStage = currentStageForm >= 3 ? 2 : currentStageForm++;
					
					
					ipcRenderer.send("NewStage", {Client_ID: thisID, NewStage: newStage});
				});
			});
		</script>
		
		<script name="IPC-Functions">
		
		/*********SEND*********/
		//when the show info button clicked
		document.querySelector(".btnShowInfo").addEventListener("click", function() {
			//send the 'display-client' command to the main js (will display new page with client info)
			//needs id
			let cliID = $(this).parent().parent().parent().find(".cliID").text();
			
			ipcRenderer.send("display-client-Info", getClient(AllClients, cliID));
		});
		
		document.querySelector(".btnEditInfo").addEventListener("click", function() {
			//send the 'display-client-edit' command to the main js (will display new page with client info)
			//needs id
			let cliID = $(this).parent().parent().parent().find(".cliID").text();
			
			ipcRenderer.send("display-client-edit", getClient(AllClients, cliID));
		});
		
		//Update the profile picture
		window.onload = () => {
			ipcRenderer.send("user");
		}
		
		
		/*********Recieve**********/
		//gets an updated client array
		ipcRenderer.on("updatedClients", (event, data) =>{			
			AllClients = data.cliarr;
			let sentStage = data.stage == 0 ? currentStageForm : data.stage;
			
			sortByNewest(AllClients);
			populateMain(sentStage);
			console.log("new clients recieved from the server");
		});
		
		//gets an updated comment array
		ipcRenderer.on("updatedComments", (event, data) =>{
			AllClients = data.cliarr;
			console.log("new comments recieved from the server");
		});
		
		//get google profile picture
		ipcRenderer.on("getUser", (event, user) => {
			document.getElementById('profilePic').setAttribute('src',user.picture);
		});


		
		</script>
		
		<script src="Scripts/TestDatabase.js"></script>
		<script name="DEV, Test ipcRenderer!">
		AllClients = testData;
		
		sortByNewest(AllClients);
		populateMain(1);
		</script>
	</body>
</html>